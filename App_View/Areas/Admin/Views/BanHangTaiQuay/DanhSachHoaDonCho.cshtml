@using App_Data.DbContextt;
@using App_Data.Models;
@using App_View.IServices;
@using App_View.Services;
@using Microsoft.AspNetCore.Identity;
@using static App_Data.Repositories.TrangThai;
@model IEnumerable<App_Data.ViewModels.HoaDon.HoaDonChoDTO>
@{
    BazaizaiContext context = new BazaizaiContext();
    IHoaDonServices hoaDonServices = new HoaDonServices();
}
@{
    ViewData["Title"] = "DanhSachHoaDonCho";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}
@* <link href="~/css/ban-hang-tai-quay.css" rel="stylesheet" /> *@
<div class="card">
    <div class="row">
        <div class="col-9">
            <div class="row" style="height: 800px;background-color:red">
                <div class="card w-100 h-100">
                    <button class="btn btn-primary" id="create-tab" style="width: 140px">Tạo tab mới</button>
                    <div id="tabs">
                        <ul>
                            @{
                                foreach (var item in Model)
                                {
                                    <li><a href="#tab-@item.MaHoaDon">@item.MaHoaDon</a></li>
                                }
                            }
                        </ul>
                        @{
                            foreach (var item in Model)
                            {
                                <div id="tab-@item.MaHoaDon" style="height:700px">
                                    <div class="table-responsive" style=" height:650px; overflow-y: scroll; overflow-x: hidden">

                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th style="width: 10%; position: sticky; top: 0; background-color: white">STT</th>
                                                    <th style="width: 0%; position: sticky; top: 0; background-color: white; display: none">IdSanPham</th>
                                                    <th style="width: 20%; position: sticky; top: 0; background-color: white">Mã sản phẩm</th>
                                                    <th style="width: 35%; position: sticky; top: 0; background-color: white">Tên sản phẩm</th>
                                                    <th style="width: 15%; position: sticky; top: 0; background-color: white">Giá bán</th>
                                                    <th style="width: 10%; position: sticky; top: 0; background-color: white">Số lượng</th>
                                                    <th style="width: 10%; position: sticky; top: 0; background-color: white">Xóa sản phẩm</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @{
                                                    int stt = 1;
                                                    foreach (var hoaDonChiTiet in item.hoaDonChiTietDTOs)
                                                    {
                                                        <tr scope="col" id="hdct-@hoaDonChiTiet.IdSanPhamChiTiet">
                                                            <td>@stt</td>
                                                            <td hidden>@hoaDonChiTiet.IdSanPhamChiTiet</td>
                                                            <td>@hoaDonChiTiet.MaSanPham</td>
                                                            <td>@hoaDonChiTiet.TenSanPham</td>
                                                            <td>@string.Format(new System.Globalization.CultureInfo("vi-VN"), "{0:C0}", hoaDonChiTiet.GiaBan)</td>
                                                            <td><input type="number" max="1000" min="1" pattern="[0-9]*" oninput="this.value = this.value.replace(/[^0-9]/g, '')" onchange="suaSoLuongSanPham('@hoaDonChiTiet.IdSanPhamChiTiet',this)" value="@hoaDonChiTiet.SoLuong" /></td>
                                                            <td><a class="btn btn-tone" onclick="XoaSanPhamTrongHoaDon('hdct-@hoaDonChiTiet.IdSanPhamChiTiet','@hoaDonChiTiet.IdSanPhamChiTiet')">X</a></td>
                                                        </tr>
                                                        stt++;
                                                    }
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-4" style="margin-left: -15px;">
                    <input type="text" class="form-control" oninput="timKiem(this.value)" id="timKiemSanPham" placeholder="Tìm kiếm sản phẩm">
                </div>
                <div class="col-8"></div>
            </div>
            <div class="row" style="height: 775px; overflow-y: scroll; overflow-x: hidden">
                <div class="row" id="body-danhsach">
                </div>
            </div>
        </div>
        <div class="col-3" style="height: 800px">
            <div class="card" style="width: 22rem; margin: 15px; height: 200px;">
                <div class="card-header" style=" line-height: 50px">
                    Khách hàng
                </div>
                <input type="text" class="form-control" placeholder="Tìm kiếm khách hàng" style="border-radius: 20px;">
            </div>
            <div class="card" style="width: 22rem; margin: 15px; min-height: 450px;">
                <div class="card-header" style=" line-height: 50px">
                    Thông tin hóa đơn
                </div>
                <div class="mb-3">
                    <table>
                        <tr>
                            <td>Mã hóa đơn: </td>
                            <td><input class="form-control" id="MaHoaDonDangChon" type="text" aria-label="default input example" style="border-bottom: 2px solid black;" disabled></td>
                        </tr>
                        <tr>
                            <td>Mã nhân viên: </td>
                            <td><input class="form-control" id="IdNhanVienTaoHoaDon" type="text" aria-label="default input example" style="border-bottom: 2px solid black;" disabled></td>
                        </tr>
                        <tr>
                            <td>Ngày tạo: </td>
                            <td><input class="form-control" id="NgayTaoHoaDon" type="text" aria-label="default input example" style="border-bottom: 2px solid black;" disabled></td>
                        </tr>
                        <tr>
                            <td>Tổng tiền hàng: </td>
                            <td><input class="form-control" type="text" id="TongTienHoaDon" aria-label="default input example" style="border-bottom: 2px solid black;" disabled></td>
                        </tr>
                        <tr>
                            <td>VouCher: </td>
                            <td><input class="form-control" type="text" id="MaVoucher" aria-label="default input example" style="border-bottom: 2px solid black;"></td>
                        </tr>
                        <tr>
                            <td>Số tiền voucher giảm:</td>
                            <td><input class="form-control" type="text" id="VoucherGiam" aria-label="default input example" style="border-bottom: 2px solid black;" disabled></td>
                        </tr>
                        <tr>
                            <td>Số tiền khuyến mãi giảm:</td>
                            <td><input class="form-control" type="text" id="KhuyenMaiGiam" aria-label="default input example" style="border-bottom: 2px solid black;" disabled></td>
                        </tr>
                        <tr>
                            <td>Tổng tiền: </td>
                            <td><input class="form-control" type="text" id="SoTienPhaiTra" aria-label="default input example" style="border-bottom: 2px solid black;" disabled></td>
                        </tr>
                        <tr>
                            <td>HT thanh toán: </td>
                            <td>
                                <select class="form-select" aria-label="Default select example">
                                    <option selected>Chọn hình thức thanh toán</option>
                                    <option value="1">Tiền mặt</option>
                                    <option value="2">Chuyển khoản</option>
                                    <option value="3">Cả tiền mặt cả chuyển khoản</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Tiền mặt: </td>
                            <td><input class="form-control" type="number" min="0" aria-label="default input example" style="border-bottom: 2px solid black;"></td>
                        </tr>
                        <tr>
                            <td>Tiền thừa: </td>
                            <td><input class="form-control" type="number" min="0" aria-label="default input example" style="border-bottom: 2px solid black;" disabled></td>
                        </tr>
                        <tr>
                            <td></td>
                            <td><button class="btn btn-success">Thanh toán</button> <button class="btn btn-danger" onclick="HuyHoaDon()">Hủy</button></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    var loading = false;
    var maHoaDonChoSelect = "";
    $(function () {
        $("#tabs").tabs({
            beforeActivate: function (event, ui) {
                if (ui.newTab.hasClass("ui-state-disabled")) {
                    event.preventDefault();
                }
            },
            activate: function (event, ui) {
                if (loading) {
                    return;
                }
                loading = true;
                var maHoaDon = $("#tabs .ui-tabs-active a").text();
                $.ajax({
                    url: '/Admin/BanHangTaiQuay/HoaDonDuocChon?maHD=' + maHoaDon,
                    type: 'GET',
                    success: function (result) {
                        $("#MaHoaDonDangChon").val(result.maHoaDon);
                        $("#NgayTaoHoaDon").val(result.ngayTao);
                        $("#TongTienHoaDon").val(result.tongTienGoc.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }));
                        $("#SoTienPhaiTra").val(result.tienPhaiTra.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }));
                        $("#KhuyenMaiGiam").val(result.soTienKhuyenMaiGiam.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }));
                        $("#VoucherGiam").val(result.soTienVoucherGiam.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }));
                        $("#MaVoucher").val("");
                        loading = false;
                    },
                    error: function (xhr, status, error) {

                    }
                });
            }
        });

        $("#create-tab").on("click", function () {
            if (loading) {
                return;
            }
            loading = true;
            if ($("#tabs ul li").length < 10) {
                var tabIndex = "";
                var tabTitle = "";
                $.ajax({
                    url: "@Url.Action("TaoHoaDonTaiQuay", "BanHangTaiQuay")",
                    type: "POST",
                    dataType: 'json',
                    success: function (response) {
                        tabIndex = response;
                        tabTitle = response;
                        var tabContent = tabIndex
                        $("<li><a href='#tab-" + tabIndex + "'>" + tabTitle + "</a></li>").appendTo("#tabs ul");
                        $("<div id='tab-" + tabIndex + "'></div>").appendTo("#tabs");
                        $("#tabs").tabs("refresh");
                        loading = false;
                    },
                    error: function (error) {
                        console.error(error);
                    },
                });
            }
            loading = false;
        });

        $("#tabs").on("click", ".ui-icon-close", function () {
            var panelId = $(this).closest("li").remove().attr("aria-controls");
            $("#" + panelId).remove();
            $("#tabs").tabs("refresh");
        });
    });
    $(() => {
        $.ajax({
            url: '/Admin/BanHangTaiQuay/LoadPartialViewDanhSachSanPham',
            type: 'GET',
            success: function (result) {
                $('#body-danhsach').append(result)
            },
            error: function (xhr, status, error) {

            }
        });
        var maHoaDon = $("#tabs .ui-tabs-active a").text();
        $.ajax({
            url: '/Admin/BanHangTaiQuay/HoaDonDuocChon?maHD=' + maHoaDon,
            type: 'GET',
            success: function (result) {
                $("#MaHoaDonDangChon").val(result.maHoaDon);
                $("#NgayTaoHoaDon").val(result.ngayTao);
                $("#TongTienHoaDon").val(result.tongTienGoc.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }));
                $("#SoTienPhaiTra").val(result.tienPhaiTra.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }));
                $("#KhuyenMaiGiam").val(result.soTienKhuyenMaiGiam.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }));
                $("#VoucherGiam").val(result.soTienVoucherGiam.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }));
                $("#MaVoucher").val("");
            },
            error: function (xhr, status, error) {

            }
        });
    })
    function timKiem(value) {
        if (loading) {
            return;
        }
        loading = true;
        $.ajax({
            url: '/Admin/BanHangTaiQuay/LoadPartialViewDanhSachSanPham?tukhoa=' + value,
            type: 'GET',
            success: function (result) {
                $('#body-danhsach').empty();
                $('#body-danhsach').append(result);
                loading = false;
            },
            error: function (xhr, status, error) {

            }
        });
    };
    function HuyHoaDon() {
        var selectedTabId = $("#tabs .ui-tabs-active a").attr("href"); // Lấy ID của tab đang được chọn
        $(selectedTabId).remove(); // Xóa nội dung tab
        $("#tabs ul li.ui-tabs-active").remove(); // Xóa tab từ danh sách tab
        $("#tabs").tabs("refresh");
    }
    function suaSoLuongSanPham(idsanpham, inputElement) {
        if (loading) {
            return;
        }
        loading = true;
        var newValue = inputElement.value;
        var element = document.getElementById(idsanpham);
        var maHoaDon = $("#tabs .ui-tabs-active a").text();
        $.ajax({
            url: '/Admin/BanHangTaiQuay/UpdateSoLuong?maHD=' + maHoaDon + '&idSanPham=' + idsanpham + '&SoLuongMoi=' + newValue + '&SoLuongTon=' + element.textContent,
            type: 'PUT',
            success: function (result) {
                if (result.soLuongCu == null) {

                    element.textContent = result.soLuongConLai;
                    var tongTien = parseInt($("#TongTienHoaDon").val().replace(/\D/g, ''), 10) + result.tongTienThayDoi;
                    var tienPhaiTra = parseInt($("#SoTienPhaiTra").val().replace(/\D/g, ''), 10) + result.soTienTraLaiThayDoi;
                    var khuyenMaiGiam = parseInt($("#KhuyenMaiGiam").val().replace(/\D/g, ''), 10) + result.soTienKhyenMaiGiam;
                    $("#TongTienHoaDon").val(tongTien.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }));
                    $("#SoTienPhaiTra").val(tienPhaiTra.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }));
                    $("#KhuyenMaiGiam").val(khuyenMaiGiam.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }));
                    $("#VoucherGiam").val(result.soTienVoucherGiam.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }));
                    $("#MaVoucher").val("");
                    loading = false;
                }
                else {
                    element.textContent = result.soLuongConLai;
                    inputElement.value = result.soLuongCu;
                    alert("Số lượng không đủ")
                    loading = false;
                }
            },
            error: function (xhr, status, error) {

            }
        });
        if (newValue == 0 || newValue == "") {
            var foundElement = $("#tab-" + maHoaDon + " table tbody").find("tr[id='hdct-" + idsanpham + "']");
            foundElement.remove();
        }
    }
    function isInteger(value) {
        return /^\d+$/.test(value);
    }
    function XoaSanPhamTrongHoaDon(idTr, idSanPham) {
        if (loading) {
            return;
        }
        loading = true;
        var maHoaDon = $("#tabs .ui-tabs-active a").text();
        var element = document.getElementById(idSanPham);
        $.ajax({
            url: '/Admin/BanHangTaiQuay/XoaSanPhamKhoiHoaDon?maHD=' + maHoaDon + '&idSanPham=' + idSanPham,
            type: 'DELETE',
            success: function (result) {

                if (isInteger(element.textContent)) {
                    element.textContent = parseInt(element.textContent, 10) + result.soLuongConLai;
                    var tongTien = parseInt($("#TongTienHoaDon").val().replace(/\D/g, ''), 10) + result.tongTienThayDoi;
                    var tienPhaiTra = parseInt($("#SoTienPhaiTra").val().replace(/\D/g, ''), 10) + result.soTienTraLaiThayDoi;
                    var khuyenMaiGiam = parseInt($("#KhuyenMaiGiam").val().replace(/\D/g, ''), 10) + result.soTienKhyenMaiGiam;
                    $("#TongTienHoaDon").val(tongTien.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }));
                    $("#SoTienPhaiTra").val(tienPhaiTra.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }));
                    $("#KhuyenMaiGiam").val(khuyenMaiGiam.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }));
                    $("#VoucherGiam").val(result.soTienVoucherGiam.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }));
                    $("#MaVoucher").val("");
                    loading = false;
                } else {
                    element.textContent = result.soLuongConLai;
                    var tongTien = parseInt($("#TongTienHoaDon").val().replace(/\D/g, ''), 10) + result.tongTienThayDoi;
                    var tienPhaiTra = parseInt($("#SoTienPhaiTra").val().replace(/\D/g, ''), 10) + result.soTienTraLaiThayDoi;
                    var khuyenMaiGiam = parseInt($("#KhuyenMaiGiam").val().replace(/\D/g, ''), 10) + result.soTienKhyenMaiGiam;
                    $("#TongTienHoaDon").val(tongTien.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }));
                    $("#SoTienPhaiTra").val(tienPhaiTra.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }));
                    $("#KhuyenMaiGiam").val(khuyenMaiGiam.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }));
                    $("#VoucherGiam").val(result.soTienVoucherGiam.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }));
                    $("#MaVoucher").val("");
                    loading = false;

                }
            },
            error: function (xhr, status, error) {

            }
        });
        var foundElement = $("#tab-" + maHoaDon + " table tbody").find("tr[id='" + idTr + "']");
        foundElement.remove();
    }
</script>
@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
}

