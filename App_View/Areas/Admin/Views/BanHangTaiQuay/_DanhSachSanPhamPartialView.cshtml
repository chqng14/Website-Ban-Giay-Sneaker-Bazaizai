@model IEnumerable<App_Data.ViewModels.SanPhamChiTietViewModel.ItemShopViewModel>;

@foreach (var item in Model)
{
    <div class="col-3">
        <div class="card" style="width: 16rem;">
            <div class="card-body">
                <h5 class="card-title"> </h5>
                <img src="/AnhSanPham/@item.Anh" class="card-img-top" alt="..." style="height:200px;width:200px">
                <p class="card-text">
                    <span>@item.TenSanPham/@item.MauSac/@item.KichCo</span>
                    <br />
                    @{
                        if (item.GiaGoc != item.GiaThucTe)
                        {
                            <span style="color: red;">
                                Giá:<strike>@string.Format(new System.Globalization.CultureInfo("vi-VN"), "{0:C0}", @item.GiaGoc)</strike><br>
                            </span>
                        }
                        else
                        {
                            <br>
                        }
                    }
                    <span style="color: red;">
                        Giá: @string.Format(new System.Globalization.CultureInfo("vi-VN"), "{0:C0}", @item.GiaThucTe)
                    </span><br>
                    @{

                        <span>Số lượng:</span>
                        if (item.SoLuongTon > 0)
                        {
                            <span id="@item.IdChiTietSp">@item.SoLuongTon</span>
                        }
                        else
                        {
                            <span id="@item.IdChiTietSp">Hết Hàng</span>
                        }
                        <button onclick="add('@item.IdChiTietSp')" class="btn btn-success" style="float: right;"> Add </button>
                    }
                </p>
            </div>
        </div>
    </div>

}
<script>
    function add(id) {
        var element = document.getElementById(id);
        if (parseInt(element.textContent, 10) > 1) {
            maHoaDon = $("#tabs .ui-tabs-active a").text();
            $.ajax({
                url: "@Url.Action("ThemSanPhamVaoHoaDon", "BanHangTaiQuay")",
                type: "POST",
                data: {
                    "maHD": maHoaDon,
                    "idSanPham": id
                },
                success: function (response) {
                    var foundElement = $("#tab-" + maHoaDon + " table tbody").find("tr[id='hdct-" + response.idSanPhamChiTiet + "']");
                    if (foundElement.length > 0) {
                        var inputWithinFoundElement = foundElement.find("input");
                        inputWithinFoundElement.val(response.soLuong);
                    } else {
                        var stt = $("#tab-" + maHoaDon + " table tbody tr").length + 1;

                        // Create a new row and append it to the table
                        var newRow = $("<tr>").attr("id","hdct-"+response.idSanPhamChiTiet);
                        newRow.append("<td>" + stt + "</td>");
                        newRow.append("<td hidden>" + response.idSanPhamChiTiet + "</td>");
                        newRow.append("<td></td>");
                        newRow.append("<td>" + response.tenSanPham + "</td>");
                        var formattedCurrency = response.giaBan.toLocaleString('vi-VN', {
                            style: 'currency',
                            currency: 'VND',
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        });

                        newRow.append("<td>" + formattedCurrency + "</td>");

                        // Create an input element for quantity
                        var quantityInput = $("<input>").attr({
                            type: "number",
                            max: 1000,
                            min: 1,
                            value: response.soLuong
                        });
                        newRow.append($("<td>").append(quantityInput));
                        newRow.append("<td><a class='btn btn - tone'>X</a></td>");
                        // Append the new row to the table body
                        $("#tab-" + maHoaDon + " table tbody").append(newRow);
                    }

                },
                error: function (error) {
                    console.error(error);
                }
            });
            if (parseInt(element.textContent, 10) === 1) { // Đổi dấu bằng sang '==='
                element.textContent = "Hết hàng";
            }
            else {
                var currentNumber = parseInt(element.textContent, 10);
                var newNumber = currentNumber - 1;
                element.textContent = newNumber;
            }
        }

        else {
            element.textContent = "Hết hàng";
        }
    }

</script>
