@using App_View.IServices;
@using App_View.Services;
@model App_Data.ViewModels.SanPhamChiTietViewModel.ItemDetailViewModel
@inject IDanhGiaService _DanhGiaService
@{
    _DanhGiaService = new DanhGiaService();
    var TongSoDanhGia = await _DanhGiaService.GetTongSoDanhGia(@Model.IdChiTietSp!);
    var SaoTb = await _DanhGiaService.GetSoSaoTB(@Model.IdChiTietSp);

}
<div class="app-content">
    <div id="body_detail">
        @await Html.PartialAsync("_SanPhamDatailPatialView", Model)
    </div>

    <!--====== Product Detail Tab ======-->
    <div class="u-s-p-y-90">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="pd-tab">
                        <div class="u-s-m-b-30">
                            <ul class="nav pd-tab__list">
                                <li class="nav-item">

                                    <a class="nav-link" data-toggle="tab" href="#pd-desc">MÔ TẢ</a>
                                </li>
                                <li class="nav-item">

                                    <a class="nav-link active" id="view-review" data-toggle="tab" href="#pd-rev">
                                        ĐÁNH GIÁ

                                        <span>(@TongSoDanhGia)</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <div class="tab-content">

                            <!--====== Tab 1 ======-->
                            <div class="tab-pane" id="pd-desc">
                                <div class="pd-tab__desc" style="max-width: none !important">
                                    @if (string.IsNullOrEmpty(Model.MoTaSanPham))
                                    {
                                        <div style="DISPLAY: flex; justify-content: center; align-items: center; height: 200px; width: 100%; background-repeat: no-repeat; background-size: contain; background-position: center; background-image: url('https://i.stack.imgur.com/8yFqA.gif');">
                                            <span style="
    margin-top: 237px;
    color: red;
    font-weight: bold;
">
                                                Chưa có mô tả cho sản phẩm này!!!
                                            </span>
                                        </div>
                                    }
                                    else
                                    {
                                        @Html.Raw(Model.MoTaSanPham)
                                    }
                                </div>
                            </div>
                            <!--====== End - Tab 1 ======-->
                            <div class="tab-pane active show" id="pd-rev">
                                <partial name="_DanhGiaPartial" />
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--====== End - Product Detail Tab ======-->
    <!--====== End - Section 1 ======-->
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    function RemoveToFavorite() { 
        var data = {};
        $('#addToFavoriteForm').find("input, select, textarea").each(function () {
            var fieldType = $(this).attr("type");
            var fieldName = $(this).attr("name");
            var fieldValue;

            if (fieldType === "checkbox" || fieldType === "radio") {
                fieldValue = $(this).is(":checked");
            } else {
                fieldValue = $(this).val();
            }

            data[fieldName] = fieldValue;
        });

        $.ajax({
            url: '/SanPhamYeuThich/Remove',
            type: 'POST',
            data: JSON.stringify(data),
            contentType: 'application/json',
            success: function (result) {
                var url = window.location.href;

                var parts = url.split('/');

                var id = parts.pop();

                loadPartialDetailProduct(id)
            },
            error: function (xhr, status, error) {
                console.log(xhr.responseText);
                console.log(status);
                console.log(error);
                console.log(xhr);
                if (xhr.status === 401) {
                    window.location.href = '/login'
                }
            }
        });
    }

    function AddToFavorite() {
        var data = {};
        $('#addToFavoriteForm').find("input, select, textarea").each(function () {
            var fieldType = $(this).attr("type");
            var fieldName = $(this).attr("name");
            var fieldValue;

            if (fieldType === "checkbox" || fieldType === "radio") {
                fieldValue = $(this).is(":checked");
            } else {
                fieldValue = $(this).val();
            }

            data[fieldName] = fieldValue;
        });
        $.ajax({
            url: '/SanPhamYeuThich/Create',
            type: 'POST',
            data: JSON.stringify(data),
            contentType: 'application/json',
            success: function (result) {
                var url = window.location.href;

                var parts = url.split('/');

                var id = parts.pop();

                loadPartialDetailProduct(id)

            },
            error: function (xhr, status, error) {
                console.log(xhr.responseText);
                console.log(status);
                console.log(error);
                console.log(xhr);
                if (xhr.status === 401) {
                    window.location.href = '/login'
                }
            }
        });
    }

    $(document).off('change', '[name="color"]')
    $(document).on('change', '[name="color"]', function () {
        //$('.preloader').addClass('is-active');
        var data = new FormData();
        data.append('id', $('[name="IdChiTietSp"]').val());
        data.append('mauSac', $('[name="color"]:checked').val());
        $.ajax({
            url: '/SanPhamChitiets/GetItemDetailViewModelWhenSelectColor',
            type: 'GET',
            data: {
                id: $('[name="IdChiTietSp"]').val(),
                mauSac: $('[name="color"]:checked').val()
            },
            success: function (result) {
                loadPartialDetailProduct(result.idChiTietSp);
            },
            error: function (xhr, status, error) {
                console.log(xhr.responseText);
                console.log(status);
                console.log(error);
                console.log(xhr);
            }
        });
    })

    function loadPartialDetailProduct(idChiTietSp) {
        $.ajax({
            url: '/SanPhamChiTiets/LoadPartialDetailProduct',
            type: 'GET',
            data: { "id": idChiTietSp },
            success: function (resultPartial) {
                $('#body_detail').empty().html(resultPartial);
                window.history.pushState({}, null, '/SanPhamChiTiets/Details/'+ idChiTietSp);
                loadScripts();

            },
            error: function (xhr, status, error) {
                console.error(xhr.responseText);
                console.error(status);
                console.error(error);
            }
        });
    }

    function loadScripts() {
        setTimeout(function () {
            $.getScript('/js/vendor.js', function () {
                $.getScript('/js/jquery.shopnav.js', function () {
                    $.getScript('/js/app.js', function () { });
                });
            });
        }, 100)
    }

    $(document).off('change', '.pd-detail__size')
    $(document).on('change', '.pd-detail__size', function () {
        //$('.preloader').addClass('is-active');
        const idSpct = $('[name="IdChiTietSp"]').val();
        const size = $(this).find('input:checked').val();

        $.ajax({
            url: '/SanPhamChitiets/GetItemDetailViewModelWhenSelectSize',
            type: 'GET',
            data: {
                id: idSpct,
                size: size,
            },
            success: function (result) {
                loadPartialDetailProduct(result.idChiTietSp);
            },
            error: function (xhr, status, error) {
                console.log(xhr.responseText);
                console.log(status);
                console.log(error);
                console.log(xhr);
            }
        });
    })

    const updateViewCartMini = () => {

        $.ajax({
            url: '/GioHangChiTiets/GetGioHangMiniModel',
            type: 'GET',
            success: function (result) {
                $('#body-mini-cart').empty().html(result)
            },
            error: function (xhr, status, error) {
                console.log(xhr.responseText);
                console.log(status);
                console.log(error);
                console.log(xhr);
            }
        });


    }

    window.addEventListener("popstate", function (e) {
        $.ajax({
            url: window.location.href,
            type: "GET",
            success: function (data) {
                $("body").html(data);
            },
            error: function (xhr, status, error) {
            }
        });
    });

    $(document).off('click', 'button[data-modal-id="#add-to-cart"]');
    $(document).on('click', 'button[data-modal-id="#add-to-cart"]', function () {

        var data1 = {};
        $('.pd-detail__form').find("input, select, textarea").each(function () {
            var fieldType = $(this).attr("type");
            var fieldName = $(this).attr("name");
            var fieldValue;

            if (fieldType === "checkbox" || fieldType === "radio") {
                fieldValue = $(this).is(":checked");
            } else {
                fieldValue = $(this).val();
            }

            data1[fieldName] = fieldValue;
        });



        $.ajax({
            url: '/GioHangChiTiets/AddToCart',
            type: 'POST',
            data: data1,
            success: function (result) {
                updateViewCartMini();
            },
            error: function (xhr, status, error) {
                console.log(xhr.responseText);
                console.log(status);
                console.log(error);
                console.log(xhr);
            }
        });
    });

</script>