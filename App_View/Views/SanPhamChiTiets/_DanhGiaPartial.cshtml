@using App_Data.Models;
@using App_View.IServices;
@using App_View.Services;
@using Microsoft.AspNetCore.Identity
@using Newtonsoft.Json;
@using System.Net.Http;
@inject SignInManager<NguoiDung> SignInManager
@inject UserManager<NguoiDung> UserManager
@inject IDanhGiaService _DanhGiaService
@{
    _DanhGiaService = new DanhGiaService();
    var lst = await _DanhGiaService.GetListAsyncViewModel(@Model.IdChiTietSp);
    
}

<!--====== Tab 3 ======-->
<style>
    .dropbtn {
        background-color: #3498DB;
        color: white;
        padding: 16px;
        font-size: 16px;
        border: none;
        cursor: pointer;
    }

        /* Dropdown button on hover & focus */
        .dropbtn:hover, .dropbtn:focus {
            background-color: #2980B9;
        }

    /* The container <div> - needed to position the dropdown content */
    .dropdown {
        position: relative;
        display: inline-block;
    }

    /* Dropdown Content (Hidden by Default) */
    .dropdown-content {
        display: none;
        position: absolute;
        background-color: #f1f1f1;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        z-index: 1;
    }




    .show {
        display: block;
    }


    /* CSS cho modal */
    .modal {
        display: none;
        position: fixed;
        top: -70px;
        width: 100%;
        height: 130%;
        background-color: rgba(0, 0, 0, 0.7);
        /* z-index: 1;*/
        text-align: center;
    }

    .modal-content {
        background-color: #fff;
        margin: 10% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 400px;
    }

    /* CSS cho nút đóng modal */
    .close {
        color: #888;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .report-options {
        list-style-type: none;
        padding: 0;
    }

    .report-option {
        margin-bottom: 10px;
        text-align: left;
    }

        .report-option input[type="radio"] {
            margin-right: 10px;
        }
    /* CSS cho nút "Gửi" và "Hủy" */
    .button-container {
        text-align: right;
        margin-top: 20px;
    }

        .button-container button {
            margin-right: 10px;
            padding: 10px 20px;
            background-color: orangered;
            color: white;
            border: none;
            cursor: pointer;
        }

            .button-container button:disabled {
                background-color: gray;
                cursor: not-allowed;
            }
</style>
<div class="tab-pane fade show active" id="pd-rev">
    <div class="pd-tab__rev">
        <div class="u-s-m-b-30">
            <div class="pd-tab__rev-score">
                <div class="u-s-m-b-8">
                    <h2> Đánh giá - 4.6 (Tổng thể)</h2>
                </div>
                <div class="gl-rating-style-2 u-s-m-b-8"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star-half-alt"></i></div>
                <div class="u-s-m-b-8">
                    <h4>Chúng tôi muốn lắng nghe ý kiến của bạn!</h4>
                </div>

                <span class="gl-text">Hãy cho chúng tôi những gì bạn nghĩ về sản phẩm này</span>
            </div>
        </div>
        <div class="u-s-m-b-30">
            <form class="pd-tab__rev-f1">
                <div class="rev-f1__group">
                    <div class="u-s-m-b-15">
                        <h2>23 Review(s) for Man Ruched Floral Applique Tee</h2>
                    </div>
                    <div class="u-s-m-b-15">

                        <label for="sort-review"></label><select class="select-box select-box--primary-style" id="sort-review">
                            <option selected>Sort by: Best Rating</option>
                            <option>Sort by: Worst Rating</option>
                        </select>
                    </div>
                </div>
                <div class="rev-f1__review">
                    @*  hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhh jhjhj*@

                    @if (lst != null)
                    {
                        @foreach (var item in lst)
                        {
                            if (item.ParentId == null)
                            {
                              @*  var user = await UserManager.FindByIdAsync(item.IdNguoiDung);*@

                                <div class="review-o u-s-m-b-15">
                                    <div class="review-o__info u-s-m-b-8">


                                        <img style="margin-bottom:-35px;width:50px;height:50px; object-fit:cover; border-radius:30px" src="@item.AnhDaiDien">


                                        <span class="review-o__name" style="margin-left:10px">@item.TenNguoiDung</span>
                                        <span class="review-o__name">
                                            <div class="review-o__rating gl-rating-style u-s-m-b-8" style="margin-left:60px">
                                                @if (item.SaoSp == 1)
                                                {

                                                    <i class="fas fa-star"></i>
                                                    <i class="far fa-star"></i>
                                                    <i class="far fa-star"></i>
                                                    <i class="far fa-star"></i>
                                                    <i class="far fa-star"></i>


                                                }
                                                else if (item.SaoSp == 2)
                                                {

                                                    <i class="fas fa-star"></i>
                                                    <i class="fas fa-star"></i>
                                                    <i class="far fa-star"></i>
                                                    <i class="far fa-star"></i>
                                                    <i class="far fa-star"></i>


                                                }
                                                else if (item.SaoSp == 3)
                                                {

                                                    <i class="fas fa-star"></i>
                                                    <i class="fas fa-star"></i>
                                                    <i class="fas fa-star"></i>
                                                    <i class="far fa-star"></i>
                                                    <i class="far fa-star"></i>




                                                }
                                                else if (item.SaoSp == 4)
                                                {

                                                    <i class="fas fa-star"></i>
                                                    <i class="fas fa-star"></i>
                                                    <i class="fas fa-star"></i>
                                                    <i class="fas fa-star"></i>
                                                    <i class="far fa-star"></i>



                                                }
                                                else if (item.SaoSp == 5)
                                                {

                                                    <i class="fas fa-star"></i>
                                                    <i class="fas fa-star"></i>
                                                    <i class="fas fa-star"></i>
                                                    <i class="fas fa-star"></i>
                                                    <i class="fas fa-star"></i>




                                                }

                                            </div>
                                        </span>
                                        <span class="review-o__name" style="margin-left:60px">@item.NgayDanhGia | @item.SanPhamTongQuat</span>
                                    </div>

                                    <p class="review-o__text" style="margin-left:60px">@item.BinhLuan</p>
                                    <br />


                                    @foreach (var item1 in lst)
                                    {
                                        if (item1.ParentId == item.IdDanhGia)
                                        {
                                            <div style="width:91%;margin-left:60px;background:#d5d5d5;">
                                                <br />
                                                <span style="margin-left:10px;" class="review-o__name">Phản Hồi Của Shop</span>
                                                <br />
                                                <p class="review-o__text" style="margin-left:10px;">@item1.BinhLuan</p>
                                                <br />
                                            </div>
                                            <br />

                                        }

                                    }
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-left: 60px;">
                                        <div>
                                            <button type="button" id="likeButton" style="background-color: white; cursor: pointer; border: none;">
                                                <i id="likeIcon" class="fas fa-thumbs-up" style="color: #d5d5d5;"></i>
                                            </button>
                                            <span class="review-o__name">Hữu ích?</span>
                                        </div>
                                        <div class="dropdown">
                                            <button onclick="myFunction()" class="dropbtn" id="ellipsisButton" style="background-color: white; cursor: pointer; border: none;">
                                                <i id="ellipsisIcon" style="color: #d5d5d5;" class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <div id="myDropdown" style="width:102px; height: 30px;" class="dropdown-content">

                                                <button onclick="openModal()" style="width:102px; height: 30px;" data-bs-toggle="modal" data-bs-target="#myModal"> <span class="review-o__name">Báo cáo</span></button>
                                            </div>
                                        </div>


                                    </div>
                                </div>



                            }
                        }
                    }




                </div>
            </form>
        </div>
    </div>
</div>

<div id="myModal" class="modal">
    <div class="modal-content">

        <span class="pd-detail__price">Báo cáo đánh giá này</span>
        <p class="review-o__name" style=" text-align: left; ">Vui lòng chọn lí do báo cáo</p>
        <ul class="report-options">
            <li class="report-option">
                <input type="radio" id="reason1" name="reportReason" value="Danh gia tho tuc phan cam" onchange="updateSubmitButtonState()">
                <label for="reason1" class="review-o__name">Đánh giá thô tục phản cảm</label>
            </li>
            <li class="report-option">
                <input type="radio" id="reason2" name="reportReason" value="Chua hinh anh phan cam, khoa than, khieu dam" onchange="updateSubmitButtonState()">
                <label for="reason2" class="review-o__name">Chứa hình ảnh phản cảm, khỏa thân, khiêu dâm</label>
            </li>
            <li class="report-option">
                <input type="radio" id="reason3" name="reportReason" value="Danh gia trung lap (thong tin rac)" onchange="updateSubmitButtonState()">
                <label for="reason3" class="review-o__name">Đánh giá trùng lặp (thông tin rác)</label>
            </li>
            <li class="report-option">
                <input type="radio" id="reason4" name="reportReason" value="Chua thong tin ca nhan" onchange="updateSubmitButtonState()">
                <label for="reason4" class="review-o__name">Chứa thông tin cá nhân</label>
            </li>
            <li class="report-option">
                <input type="radio" id="reason5" name="reportReason" value="Quang cao trai phep" onchange="updateSubmitButtonState()">
                <label for="reason5" class="review-o__name">Quảng cáo trái phép</label>
            </li>
            <li class="report-option">
                <input type="radio" id="reason6" name="reportReason" value="Danh gia khong chinh xac / gay hieu lam" onchange="updateSubmitButtonState()">
                <label for="reason6" class="review-o__name">Đánh giá không chính xác / gây hiểu lầm (ví dụ như: đánh giá và sản phẩm không khớp, ...)</label>
            </li>
            <li class="report-option">
                <input type="radio" id="reason7" name="reportReason" value="Vi pham khac" onchange="updateSubmitButtonState()">
                <label for="reason7" class="review-o__name">Vi phạm khác</label>
            </li>
        </ul>
        <div id="additional" style="display: none;">
            <input class="review-o__name" style=" width: 100%; height: 30px;" id="additionalInput" type="text" placeholder="Vui lòng mô tả chi tiết vi phạm (bắt buộc)" onchange="updateSubmitButtonState()" />

        </div>
        <div class="button-container">
            <button id="cancelButton" style="background-color: white; color: black;" onclick="closeModal()">Hủy</button>
            <button id="submitButton" disabled>Gửi</button>
        </div>
    </div>
</div>
<script>
    function preventDefaultAndShowModal() {
        event.preventDefault(); // Ngăn chặn hành vi mặc định của liên kết
        var myModal = new bootstrap.Modal(document.getElementById('myModal'));
        myModal.show();
    }
</script>
<script>

    function myFunction() {
        event.preventDefault();
        document.getElementById("myDropdown").classList.toggle("show");
    }

    window.onclick = function (event) {
        if (!event.target.matches('.dropbtn')) {
            var dropdown = document.getElementById("myDropdown");
            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
            }
        }
    }
</script>
<script>
    const likeButton = document.getElementById('likeButton');
    const likeIcon = document.getElementById('likeIcon');

    let isLiked = false;

    likeButton.addEventListener('click', function () {
        if (isLiked) {
            likeIcon.style.color = '#d5d5d5'; // Đổi màu icon về màu cũ
        } else {
            likeIcon.style.color = 'red'; // Đổi màu icon sang màu đỏ
        }

        isLiked = !isLiked; // Đảo ngược trạng thái "đã thích"
    });
</script>
<script>
    function openModal() {
        if (!event.target.matches('.dropbtn')) {
            var dropdown = document.getElementById("myDropdown");

            dropdown.classList.remove('show');

        }
        event.preventDefault();
        var modal = document.getElementById("myModal");
        modal.style.display = "block";
        window.addEventListener("click", function (event) {
            if (event.target === modal) {
                modal.style.display = "block"; // Không làm gì nếu ấn bên ngoài modal
            }
        });
    }

    function closeModal() {
        var modal = document.getElementById("myModal");
        modal.style.display = "none";
    }

    window.onclick = function (event) {
        var modal = document.getElementById("myModal");
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
    function updateSubmitButtonState() {
        const radioButtons = document.querySelectorAll('input[type="radio"]');
        const submitButton = document.getElementById("submitButton");
        const isAnyRadioButtonChecked = Array.from(radioButtons).some(radio => radio.checked);
        submitButton.disabled = !isAnyRadioButtonChecked;

        const lastRadioButton = document.getElementById("reason7");
        const additional = document.getElementById("additional");
        const additionalInput = document.getElementById("additionalInput");
        const inputValue = additionalInput.value.trim();

        if (lastRadioButton.checked) {
            additional.style.display = "block";
            if (inputValue === "") {
                submitButton.disabled = true;
            }
            additionalInput.addEventListener("input", function () {
                const inputValue = additionalInput.value.trim();
                submitButton.disabled = inputValue === "";
            });
        } else {
            additional.style.display = "none";
            additionalInput.removeEventListener("input", null); // Ngừng lắng nghe sự kiện khi ẩn ô input
        }
    }



</script>

<!--====== End - Tab 3 ======-->
